language: java
jdk:
  - openjdk8
branches:
  only:
    - master
# See: https://docs.travis-ci.com/user/languages/java#Caching
before_cache:
  - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
before_script:
  - cp .travis/application.example.properties config/application.properties
  - cp .travis/travis.gradle.properties gradle.properties
  - psql -c 'create database commcarehq;' -U postgres
  - psql -c 'create database formplayer;' -U postgres
script:
  - ./gradlew copyTestResources
  - ./gradlew check
  - ./gradlew bootJar
services:
  - postgresql
  - redis-server
  - docker
addons:
  postgresql: "9.6"
env:
  global:
  - MALLOC_ARENA_MAX=1
  - GRADLE_OPTS="-Xmx512m"
  # DOCKER_USERNAME
  - secure: "nxxU6owCbNOV3D3dsCCTn1fFrScVniPCu5jYJfGfyOR/inAMeGgkOsnc3N7pNtRichIGbhobgZiI+tReXpD9OmeckboGzEtOfJxd5HjkO+vnG5TMbRspssppcVXTsqOk2+ZGsQrPvkNLwWdL3u1Zk7SnuRWSQxszeeUK9twHcHsM0khF8g4eKFIapdHuyRevRBHsEbdrIUKsxtWkTpfKT+NmW8zJ10B+zf2bhjZagz1o1LK32upT3szipdPJg23DaPgdxErUV+SzV1QBv9mrEZMcUY/dvs23hyHPx3PHiZPPlifLGigH5kfDyPvoUOkSS0PryHoBZvNs6glTtETSN8SPdq60woL9iiMe42MuPkwJhTux/y/kttju4we9fh528rTt64tlApY99y9TGiJ8NyUx8/BZv+BMoPiqibiIf214zPkioPUy+6qct4fj9+g7UNx5C1g3lgv4J2k3cqgkR2GpsXlVSSCtHf5n1GgVy2QAOhV/yUAwTRE0tXyoMaKn/pLok4yH5gwuj6fIqmuSv/qNAZEg9JXNuSvSfw5l2HKuN4KglZ6o1At9FV0yPn3ClrqBbbvaixotPqKSrVWhm59r0i4Bp/O3XYE5Le+xJQ0QrE6Jh3ozpYHWms2YhwKr0hZAAK2PDl6SBExsgdJyAI8TU4wfzm33DcbXPB0no1E="
  # DOCKER_PASSWORD
  - secure: "iMPp/wdBUBcutjhnwRJErHQW/yrYuFKwnOkgasT+/gAa9Ex7L+akaO2e9lXLE1A3dmzjNU845uD80HFqocF7WzMcdOXVDb9S9LArIBj/K+jGFQP0UyvnX/w7afUv5Y3+4/FmC8pT7KQJBUrnUYOOUNRnMfIYiELLLxQvdYAYzDKlHoHP9VW7PMoXRUTysSvv/Sv6czCNSf5ahxJYvpA3qRB892yd7l7eWlAUdLr4mzaFFxwZLEOgcY75Y2PwhMZvjcsCrgcMwg+ze3Iw5kJuNXswRJFhy8nmfoQkpmJixkdPXJTAZqFsIH0+Fw5cv8S/cmBOVUywsS+nEEt6DUW4RrgsVKaHXdo11ylkIV1AX9kafnUCpX5xj/ceGhQtQfTOb7iDiODsO/4lIQYz2yBHHGUqgs3nBuUtzQny+p4PhLhZjMQME9aFyMvrt2oJD6wmHPmkZz/IbW7MWCVaIvyd22hkaIe5FCEWyj7LKiCwveBRXyrSFoqVrBqBPxxl4qjcJDFs3c3Mh/WDa3fVYTnlpbH2U1p32+opTKh0Fp9NzafqSBgan8hVcXjeyxtIJ71YLR6567ABU0bL/f+kc6NERUrE4H7yP+iRKtvq/IZhN/dFlmr6vR5y8eBgjj5qQnZJLXCfNwmMK4f6oSHaONAK1KED64Yv4YUViuCB95DfIkw="
  # CODECOV_TOKEN
  - secure: "WlC5xE+inkq9UPxNx+HB/AJBqBoHbf9BMyQkSkOhlSP/rcjHvZ96VuRmJBtWDgVMq9k8TQX7CDfa+l3GoU+anZtrCxBlGNsVH68aEPNMYti0WcwrqfXGRQwxoQffVmngN1uR6G+sEKCXVLOxd60+y4LaegvVUMHgRJa4lzq+gfA/Msl+Vgx0ougxXChv/u+xXeg3GCgWOZOpbnNTvsDZdqTkQ5aE8/r4Xxhc022yMsXVGupzdnnYUElRuXD+TqSTSuBtri3lqKOioTow8VrwbxeeJtg08YQr7Xf5KZqVyYe6FrbvXVuwsvF4YnagqwYX6tzsXqZByGhV2nbje3zQYT/byee2wUz5freF/PNb+YoL+klyOKrZUn1v8MANu0WgbG1Lwuwq51V40/IWXdTltpQNYo6m1jx2q1sRFcG+G+aajej2YCFosJuY/GBLgwkZQpo+VMuXmxd2hxqgH+LmIOesZY0dktY6V7mS1i7hM5C8Ac7FadHK9rrRq6H5AFcDrrlcs7fENtZupgMke8ui6kOm5G08XM/QT/fcxwieyu1Dr5q1OR8MVWTDto42yVsXJQrywsOGpubDSZebMs0j/ulquh/7y3JXwfvOKQ+evN1DGHV6oNR8FlSIahfUWybCl/h1tpQpWgc2/8mtLUVZi3YGZE8oRH5brctLbcoOsRE="
after_failure:
  - cat /home/travis/build/dimagi/formplayer/build/reports/tests/test/index.html
after_success:
  - bash <(curl -s https://codecov.io/bash)
deploy:
  provider: script
  skip_cleanup: true
  script: bash scripts/docker_deploy.sh
  on:
    branch: master
