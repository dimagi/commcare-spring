language: java
jdk:
  - openjdk8
branches:
  only:
    - master
# See: https://docs.travis-ci.com/user/languages/java#Caching
before_cache:
  - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
before_script:
  - cp .travis/application.example.properties config/application.properties
  - cp .travis/travis.gradle.properties gradle.properties
  - psql -c 'create database commcarehq;' -U postgres
  - psql -c 'create database formplayer;' -U postgres
script:
  - ./gradlew copyTestResources
  - ./gradlew check
  - ./gradlew bootJar
services:
  - postgresql
  - redis-server
  - docker
addons:
  postgresql: "9.6"
env:
  global:
  - MALLOC_ARENA_MAX=1
  - GRADLE_OPTS="-Xmx512m"
  # DOCKER_USERNAME
  - secure: "nxxU6owCbNOV3D3dsCCTn1fFrScVniPCu5jYJfGfyOR/inAMeGgkOsnc3N7pNtRichIGbhobgZiI+tReXpD9OmeckboGzEtOfJxd5HjkO+vnG5TMbRspssppcVXTsqOk2+ZGsQrPvkNLwWdL3u1Zk7SnuRWSQxszeeUK9twHcHsM0khF8g4eKFIapdHuyRevRBHsEbdrIUKsxtWkTpfKT+NmW8zJ10B+zf2bhjZagz1o1LK32upT3szipdPJg23DaPgdxErUV+SzV1QBv9mrEZMcUY/dvs23hyHPx3PHiZPPlifLGigH5kfDyPvoUOkSS0PryHoBZvNs6glTtETSN8SPdq60woL9iiMe42MuPkwJhTux/y/kttju4we9fh528rTt64tlApY99y9TGiJ8NyUx8/BZv+BMoPiqibiIf214zPkioPUy+6qct4fj9+g7UNx5C1g3lgv4J2k3cqgkR2GpsXlVSSCtHf5n1GgVy2QAOhV/yUAwTRE0tXyoMaKn/pLok4yH5gwuj6fIqmuSv/qNAZEg9JXNuSvSfw5l2HKuN4KglZ6o1At9FV0yPn3ClrqBbbvaixotPqKSrVWhm59r0i4Bp/O3XYE5Le+xJQ0QrE6Jh3ozpYHWms2YhwKr0hZAAK2PDl6SBExsgdJyAI8TU4wfzm33DcbXPB0no1E="
  # DOCKER_PASSWORD
  - secure: "iMPp/wdBUBcutjhnwRJErHQW/yrYuFKwnOkgasT+/gAa9Ex7L+akaO2e9lXLE1A3dmzjNU845uD80HFqocF7WzMcdOXVDb9S9LArIBj/K+jGFQP0UyvnX/w7afUv5Y3+4/FmC8pT7KQJBUrnUYOOUNRnMfIYiELLLxQvdYAYzDKlHoHP9VW7PMoXRUTysSvv/Sv6czCNSf5ahxJYvpA3qRB892yd7l7eWlAUdLr4mzaFFxwZLEOgcY75Y2PwhMZvjcsCrgcMwg+ze3Iw5kJuNXswRJFhy8nmfoQkpmJixkdPXJTAZqFsIH0+Fw5cv8S/cmBOVUywsS+nEEt6DUW4RrgsVKaHXdo11ylkIV1AX9kafnUCpX5xj/ceGhQtQfTOb7iDiODsO/4lIQYz2yBHHGUqgs3nBuUtzQny+p4PhLhZjMQME9aFyMvrt2oJD6wmHPmkZz/IbW7MWCVaIvyd22hkaIe5FCEWyj7LKiCwveBRXyrSFoqVrBqBPxxl4qjcJDFs3c3Mh/WDa3fVYTnlpbH2U1p32+opTKh0Fp9NzafqSBgan8hVcXjeyxtIJ71YLR6567ABU0bL/f+kc6NERUrE4H7yP+iRKtvq/IZhN/dFlmr6vR5y8eBgjj5qQnZJLXCfNwmMK4f6oSHaONAK1KED64Yv4YUViuCB95DfIkw="
  # CODECOV_TOKEN
  - secure: "RTrJrJfBFOlvvaCfSCg7MzILi0D3jIfFUAv2U+Aum6xHwd0sDqc46PLhr901vUsvd96p+y5aD4tbC+ORashiMzlZ1mtvN8O1+s73Fk/+PIgCHRmJhIMmh3Bee7ko+x6Qq+PzXoT3FGXdj1y5huWI+znOevcNcNr8xia5z1hQVu0L7HwiSHyCrhpeRX3ytz2O7NpCr7cnm/MjlCmT1qBnL55FRWVU9nbSuiHcfL2iqWkSR7Kl0GwXa6Ie9Z++GjDTuPsySdWNELVGCuySP+ZSZcqKtlRDX0gAfRerqyHl9NCu14NltmOrKkj+12A5pishfP/5B5/u2k62I/o5pF/ONX59T627azP6GjXJunvaSWHudmyjG3aVfVr6mWsqEfuR5c+QMxa3NizXl7wUUtKIdvY/JTRYfkG1gKp9jadL/CBQpOzA85MKmedChSta3MSFcsZpSl9DbV9oEoYsFzksC6Pwb3nVEwpkIacyR7SRoh8WzjQLQi6jNBHSH8MiBgr6gU0qPwBENLWb5hJQrGhcE0zAc9r3IjrX4ehwr3eRxy7ofqRGJNFl5FA2cwsrOBb7M8M+Wu/9JBgIshF2OSvF8CBeK9MEfhvkWnxWV3EUfxuL1/9C2+12Ug0rJCRdHL14Mph9WAXHv4xOHZjHKg3VN0OUaOEiifPBpx6RIZaH/+g="
after_failure:
  - cat /home/travis/build/dimagi/formplayer/build/reports/tests/test/index.html
after_success:
  - bash <(curl -s https://codecov.io/bash)
deploy:
  provider: script
  skip_cleanup: true
  script: bash scripts/docker_deploy.sh
  on:
    branch: master
